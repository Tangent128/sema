#!./sema

local running = true

local c = 0

function command.incr(...)
	c = c + 1
	reply(c, ...)
	local status = run{"sleep", 1}
	reply(status)
end

function command.lsenv()
	for name in DEBUG.pairs(DEBUG.api) do
		reply(name)
	end
	reply "====="
	for name in DEBUG.pairs(_ENV) do
		reply(name)
	end
end

function command.gc()
	--for x in DEBUG.pairs(DEBUG.queue.getActive().script.threads) do
	--DEBUG.print(x)
	--end
	DEBUG.collectgarbage("collect")
end

function command.quit()
	running = false
	signal(nil, SIGKILL)
end

function command.down()
	setEvent("up", false)
	-- sleep doesn't die easily...
	signal(nil, SIGKILL)
end

local bsleep = parallel(function()
	--DEBUG.print"bsleep"
	local i = 1
	while true do
		i = i + 1
		waitEvent "breset"
		run {
			"sleep", DEBUG.tostring(i)
		}
		DEBUG.print "bsleep!"
	end
end)

function command.breset()
	signal(bsleep, SIGKILL)
	triggerEvent"breset"
end

--DEBUG.print(threadName())

while running do

runIfUp{
	"sleep", "300"
}

DEBUG.print "looop!"

end

--DEBUG.print "done!"

